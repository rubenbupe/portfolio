---
import type { HTMLAttributes } from 'astro/types';
import { cn } from '../lib/utils';

type Props = HTMLAttributes<'section'> & {
	zoomEffect?: boolean;
};

const { class: className, zoomEffect, ...rest } = Astro.props;
---

<section class={cn('w-full max-w-6xl px-6 md:px-12 self-center', className, { 'section-zoom': zoomEffect })} {...rest}>
	<slot />
</section>

<script>
	const setupSectionEffects = () => {
		const sections = document.querySelectorAll('.section-zoom') as unknown as HTMLElement[];

		if (!sections.length) return;

		let rafId: number | null = null;
		let isScrolling = false;

		const updateEffects = () => {
			const windowHeight = window.innerHeight;

			sections.forEach((section, index) => {
				const rect = section.getBoundingClientRect();
				const visibleHeight = Math.min(rect.bottom, windowHeight) - Math.max(rect.top, 0);
				const visiblePercentage = (visibleHeight / rect.height) * 100;

				// First section
				if (index === 0) {
					const isEnteringFromBottom = rect.top > 0 && rect.top < windowHeight;
					const distanceFromBottom = windowHeight - rect.top;
					const entryProgress = Math.min(1, distanceFromBottom / (windowHeight * 0.5));

					if (isEnteringFromBottom && entryProgress < 1) {
						const scale = 0.85 + entryProgress * 0.15;
						section.style.transform = `scale(${scale})`;
						section.style.filter = '';
						return;
					}
				}

				// Other sections
				const isLeavingTop = rect.top < 0 && visiblePercentage < 30 && visiblePercentage > 0;

				if (isLeavingTop) {
					const intensity = 1 - visiblePercentage / 30;
					const blurAmount = intensity * 8;
					const scaleAmount = 1 + intensity * 0.1;
					const translateY = intensity * 50;

					section.style.filter = `blur(${blurAmount}px)`;
					section.style.transform = `scale(${scaleAmount}) translateY(${translateY}px)`;
				} else {
					section.style.filter = '';
					section.style.transform = '';
				}
			});

			isScrolling = false;
		};

		const onScroll = () => {
			if (!isScrolling) {
				isScrolling = true;
				if (rafId !== null) {
					cancelAnimationFrame(rafId);
				}
				rafId = requestAnimationFrame(updateEffects);
			}
		};

		const cleanup = () => {
			document.removeEventListener('scroll', onScroll, { passive: true } as any);
			if (rafId !== null) {
				cancelAnimationFrame(rafId);
			}
		};

		document.addEventListener('scroll', onScroll, { passive: true } as any);
		document.addEventListener('astro:before-swap', cleanup);

		updateEffects();
	};

	setupSectionEffects();

	document.addEventListener('astro:after-swap', () => {
		setupSectionEffects();
	});
</script>

<style>
	.section-zoom {
		transition:
			transform 0.3s ease-out,
			filter 0.3s ease-out;
	}
</style>
