---
type Props = {
	color: string;
	borderColor: string;
};

const { color, borderColor } = Astro.props;
---

<style define:vars={{ color, 'border-color': borderColor }}></style>

<script>
	// Scroll events can be expensive, it is recommended to change them once
	// scroll css animations are supported for most users.
	// https://caniuse.com/mdn-css_properties_animation-timeline_scroll
	const animationStartOffset = 50;
	const animationEndOffset = 450;

	const scrollHandler = () => {
		const conicHeaders = document.querySelectorAll('.conic-header') as unknown as HTMLElement[];

		if (!conicHeaders.length) return;

		let rafId: number | null = null;
		let isScrolling = false;

		const updateAnimations = () => {
			const windowHeight = window.innerHeight;

			conicHeaders.forEach(conicHeader => {
				const rect = conicHeader.getBoundingClientRect();

				if (rect.y > windowHeight || rect.bottom < 0) {
					return;
				}

				const fromBottom = windowHeight - rect.y;
				const progress = (fromBottom - animationStartOffset) / animationEndOffset;

				const rightPercentage = Math.min(100, Math.max(20, progress * 100));
				const leftPercentage = 100 - rightPercentage;
				const opacity = Math.min(1, Math.max(0.5, progress));
				const borderLeftPercentage = 50 - Math.min(30, Math.max(0, progress * 30));
				const borderRightPercentage = 100 - borderLeftPercentage;

				conicHeader.style.setProperty('--left-percent', `${leftPercentage}%`);
				conicHeader.style.setProperty('--right-percent', `${rightPercentage}%`);
				conicHeader.style.setProperty('--opacity', opacity.toString());
				conicHeader.style.setProperty('--border-left', `${borderLeftPercentage}%`);
				conicHeader.style.setProperty('--border-left-fade', `${borderLeftPercentage - 10}%`);
				conicHeader.style.setProperty('--border-right', `${borderRightPercentage}%`);
				conicHeader.style.setProperty('--border-right-fade', `${borderRightPercentage + 10}%`);
			});

			isScrolling = false;
		};

		const onScroll = () => {
			if (!isScrolling) {
				isScrolling = true;
				if (rafId !== null) {
					cancelAnimationFrame(rafId);
				}
				rafId = requestAnimationFrame(updateAnimations);
			}
		};

		const cleanup = () => {
			document.removeEventListener('scroll', onScroll, { passive: true } as any);
			if (rafId !== null) {
				cancelAnimationFrame(rafId);
			}
		};

		document.addEventListener('scroll', onScroll, { passive: true } as any);
		document.addEventListener('astro:before-swap', cleanup);

		updateAnimations();
	};

	scrollHandler();

	document.addEventListener('astro:after-swap', () => {
		scrollHandler();
	});
</script>
<div class="conic-header"></div>

<style>
	.conic-header {
		position: absolute;
		height: 600px;
		width: 100%;
		border-top: 1px solid transparent;
		--left-percent: 80%;
		--right-percent: 20%;
		--opacity: 0.5;
		--border-left: 50%;
		--border-left-fade: 40%;
		--border-right: 50%;
		--border-right-fade: 60%;
		background:
			conic-gradient(from 90deg at var(--left-percent) 0%, var(--color), transparent 180deg) 0% 0% / 50% 100% no-repeat,
			conic-gradient(from 270deg at var(--right-percent) 0%, transparent 180deg, var(--color)) 100% 0% / 50% 100%
				no-repeat;
		opacity: var(--opacity);
		border-image: linear-gradient(
				to right,
				transparent,
				transparent var(--border-left-fade),
				var(--border-color) var(--border-left),
				var(--border-color) var(--border-right),
				transparent var(--border-right-fade),
				transparent
			)
			30;
	}

	.conic-header::after {
		content: '';
		position: absolute;
		inset: 0;
		background: linear-gradient(to bottom, transparent 70%, hsl(var(--background)));
	}
</style>
